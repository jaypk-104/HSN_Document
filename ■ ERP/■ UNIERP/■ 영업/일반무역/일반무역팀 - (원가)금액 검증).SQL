/*

1.LC_DOC_NO 찾기
2.미착금액, 경비금액 확인
3.입고 원가 & 상품대체전표 원가 계정 금액 수정
  출고 원가 & 매출전표 원가계정 금액 수정

상품대체전표의 금액이 (미착금액 + 경비금액)합과 다른경우.
1.미착금액 OR 2.경비금액 잘못 배분되어 입고(M_GR_DISTR.LOC_AMT OR M_GR_DISTR.DISTR_AMT) 에들어갔는지 확인
*/

--문제되는 전표, 입고번호 LC_DOC_NO 확인.

SELECT DISTINCT A.REF_NO AS GR_NO, B.CTRL_VAL AS LC_DOC_NO --LC_DOC_NO CHK!!
FROM A_TEMP_GL A JOIN A_TEMP_GL_DTL B ON A.TEMP_GL_NO = B.TEMP_GL_NO
WHERE A.TEMP_GL_NO = 'TG202007290074'
AND B.CTRL_CD = 'LC';

/*
2-1)미착금액이 잘못 들어간경우
BL 별로 CC와 GR 금액 확인
*/
SELECT D.BL_DOC_NO, D.BL_NO, C.LOC_AMT AS BL, SUM(E.LOC_AMT) AS CC--, SUM(F.LOC_AMT) AS GR
FROM M_LC_HDR_DISTR A INNER JOIN M_LC_DTL_DISTR B ON A.LC_NO = B.LC_NO
LEFT OUTER JOIN M_BL_DTL_DISTR C ON B.LC_NO = C.LC_NO AND B.LC_SEQ = C.LC_SEQ
INNER JOIN M_BL_HDR_DISTR D ON C.BL_NO = D.BL_NO
LEFT OUTER JOIN (SELECT BL_NO, BL_SEQ , CC_NO, CC_SEQ, LOC_AMT FROM M_CC_DTL_DISTR) E ON C.BL_NO = E.BL_NO AND C.BL_SEQ = E.BL_SEQ
WHERE A.LC_DOC_NO = 'M100U2003NU00477'
GROUP BY D.BL_DOC_NO, D.BL_NO, C.LOC_AMT ;

SELECT D.BL_DOC_NO, D.BL_NO, E.CC_NO , E.CC_SEQ, C.LOC_AMT AS BL, E.LOC_AMT AS CC, F.GR_NO, F.LOC_AMT AS GR, F.DISTR_AMT --BL, CC, GR LOC_AMT CHK!!!!
FROM M_LC_HDR_DISTR A INNER JOIN M_LC_DTL_DISTR B ON A.LC_NO = B.LC_NO
LEFT OUTER JOIN M_BL_DTL_DISTR C ON B.LC_NO = C.LC_NO AND B.LC_SEQ = C.LC_SEQ
INNER JOIN M_BL_HDR_DISTR D ON C.BL_NO = D.BL_NO
LEFT OUTER JOIN M_CC_DTL_DISTR E ON C.BL_NO = E.BL_NO AND C.BL_SEQ = E.BL_SEQ
LEFT OUTER JOIN M_GR_DISTR F ON E.CC_NO = F.CC_NO AND E.CC_SEQ = F.CC_SEQ
WHERE A.LC_DOC_NO = 'M100U2003NU00477';

/*
2-2)경비금액이 잘못 배분된 경우
*/

SELECT A.MAST_CHARGE_NO,A.CHARGE_NO, A.MVMT_QTY, B.CHARGE_CD, C.JNL_NM, A.DISB_AMT, B.LOC_AMT, B.VAT_AMT
FROM M_CHARGE_BY_GR_DISTR A INNER JOIN M_CHARGE_DISTR B ON A.CHARGE_NO = B.CHARGE_NO
												    INNER JOIN A_JNL_ITEM C ON B.CHARGE_CD = C.JNL_CD AND C.JNL_TYPE = 'EC'
WHERE A.MVMT_NO IN (
SELECT MVMT_NO
FROM M_GR_DISTR a
WHERE GR_NO IN (
'GR2020062400310',
'GR2020070700293',
'GR2020070700301',
'GR2020072800206'
)
)
AND B.CHARGE_CD = 'SPC13';

/*
3. 틀린 금액 수정

3-1)입고(M_GR_DISTR)LOC_AMT OR DISTR_AMT 수정
*/
SELECT * -- GR_NO, MVMT_NO, LOC_AMT, DISTR_AMT
FROM M_GR_DISTR a
WHERE GR_NO = 'GR2020062400310'

/*
3-2)출고이력 확인
1)입고박스=출고박스(출고가 다 된경우) 가장 마지막 출고일자의 COG_GL_AMT 를 수정
2)출고가 없는 경우. 수정 X
*/
SELECT A.GR_NO, A.BOX_QTY, B.DN_BOX_QTY
FROM M_GR_DISTR A JOIN (
SELECT MVMT_NO, SUM(DN_BOX_QTY)DN_BOX_QTY
FROM M_GR_TO_DN_DISTR a
GROUP BY MVMT_NO
) B ON A.MVMT_NO = B.MVMT_NO
WHERE GR_NO = 'GR2020062400310'

SELECT *
FROM ( SELECT GR_NO, MVMT_NO, (LOC_AMT + DISTR_AMT) COG_GL_AMT, BOX_QTY FROM M_GR_DISTR ) A JOIN (
SELECT MVMT_NO, SUM(COG_GL_AMT)COG_GL_AMT, SUM(DN_BOX_QTY)DN_BOX_QTY
FROM M_GR_TO_DN_DISTR a
GROUP BY MVMT_NO
) B ON A.MVMT_NO = B.MVMT_NO
WHERE A.BOX_QTY = B.DN_BOX_QTY
AND A.COG_GL_AMT <> B.COG_GL_AMT
AND A.GR_NO = 'GR2020062400310'
--AND SUBSTR(A.MVMT_NO,3,4) >= '2020'


/*
3-3)M_GR_TO_DN_DISTR.COG_GL_AMT 을 수정한경우
매출전표의 원가계정 금액도 수정해야함.
*/

SELECT BILL_NO, C.GR_NO,SUM(COG_GL_AMT)COG_GL_AMT
FROM S_BILL_D_DISTR a JOIN M_GR_TO_DN_DISTR B ON A.DN_NO = B.DN_NO AND A.DN_SEQ = B.DN_SEQ
										 JOIN M_GR_DISTR C ON B.MVMT_NO = C.MVMT_NO

--WHERE BILL_NO = 'BN2020073100052'
WHERE C.GR_NO = 'GR2020062400310'
GROUP BY BILL_NO,C.GR_NO

